(function(){"use strict";angular.module("tubular.directives").directive("tbGrid",["tubularHttp",function(n){return{template:'<div class="tubular-grid" ng-transclude><\/div>',restrict:"E",replace:!0,transclude:!0,scope:{serverUrl:"@",serverSaveUrl:"@",serverSaveMethod:"@",pageSize:"@?",onBeforeGetData:"=?",requestMethod:"@",gridDataService:"=?service",requireAuthentication:"@?"},controller:["$scope","localStorageService","tubularPopupService","tubularModel",function(t,i,r,u){t.tubularDirective="tubular-grid";t.columns=[];t.rows=[];t.currentPage=0;t.totalPages=0;t.totalRecordCount=0;t.filteredRecordCount=0;t.requestedPage=1;t.hasColumnsDefinitions=!1;t.requestCounter=0;t.requestMethod=t.requestMethod||"POST";t.serverSaveMethod=t.serverSaveMethod||"POST";t.requestTimeout=1e4;t.currentRequest=null;t.search={Argument:"",Operator:"None"};t.isEmpty=!1;t.tempRow=new u(t,{});t.gridDataService=t.gridDataService||n;t.requireAuthentication=t.requireAuthentication||!0;t.addColumn=function(n){if(n.Name!==null){if(t.hasColumnsDefinitions!==!1)throw"Cannot define more columns. Column definitions have been sealed";t.columns.push(n)}};t.createRow=function(){var n={serverUrl:t.serverSaveUrl,requestMethod:t.serverSaveMethod,timeout:t.requestTimeout,requireAuthentication:t.requireAuthentication,data:t.tempRow};t.currentRequest=t.gridDataService.retrieveDataAsync(n);t.currentRequest.promise.then(function(n){t.$emit("tbGrid_OnSuccessfulUpdate",n);t.tempRow.$isEditing=!1},function(n){t.$emit("tbGrid_OnConnectionError",n)}).then(function(){t.currentRequest=null;t.retrieveData()})};t.newRow=function(){t.tempRow=new u(t,{});t.tempRow.$isEditing=!0};t.deleteRow=function(n){var i={serverUrl:t.serverSaveUrl+"/"+n.$key,requestMethod:"DELETE",timeout:t.requestTimeout,requireAuthentication:t.requireAuthentication};t.currentRequest=t.gridDataService.retrieveDataAsync(i);t.currentRequest.promise.then(function(i){n.$hasChanges=!1;t.$emit("tbGrid_OnRemove",i)},function(n){t.$emit("tbGrid_OnConnectionError",n)}).then(function(){t.currentRequest=null;t.retrieveData()})};t.updateRow=function(n,i){n.$isLoading=!0;var u={serverUrl:t.serverSaveUrl,requestMethod:"PUT",timeout:t.requestTimeout,requireAuthentication:t.requireAuthentication},r=t.gridDataService.saveDataAsync(n,u);i==!1&&(t.currentRequest=r);r.promise.then(function(n){t.$emit("tbGrid_OnSuccessfulUpdate",n)},function(n){t.$emit("tbGrid_OnConnectionError",n)}).then(function(){n.$isLoading=!1;t.currentRequest=null})};t.retrieveData=function(){t.pageSize=t.pageSize||20;var i=t.requestedPage==0?1:t.requestedPage,n={serverUrl:t.serverUrl,requestMethod:t.requestMethod,timeout:t.requestTimeout,requireAuthentication:t.requireAuthentication,data:{Count:t.requestCounter,Columns:t.columns,Skip:(i-1)*t.pageSize,Take:parseInt(t.pageSize),Search:t.search,TimezoneOffset:(new Date).getTimezoneOffset()}},f=t.currentRequest!==null;f&&t.currentRequest.cancel("tubularGrid("+t.$id+"): new request coming.");angular.isUndefined(t.onBeforeGetData)===!1&&t.onBeforeGetData();t.$emit("tbGrid_OnBeforeRequest",n);t.currentRequest=t.gridDataService.retrieveDataAsync(n);t.currentRequest.promise.then(function(n){if(t.requestCounter+=1,angular.isUndefined(n)||n==null){t.$emit("tbGrid_OnConnectionError",{statusText:"Data is empty",status:0});return}t.dataSource=n;t.rows=n.Payload.map(function(n){var i=new u(t,n);return i.editPopup=function(n){r.openDialog(n,i)},i});t.currentPage=n.CurrentPage;t.totalPages=n.TotalPages;t.totalRecordCount=n.TotalRecordCount;t.filteredRecordCount=n.FilteredRecordCount;t.isEmpty=t.filteredRecordCount==0},function(n){t.requestedPage=t.currentPage;t.$emit("tbGrid_OnConnectionError",n)}).then(function(){t.currentRequest=null})};t.$watch("hasColumnsDefinitions",function(n){n===!0&&t.retrieveData()});t.$watch("pageSize",function(){t.hasColumnsDefinitions&&t.requestCounter>0&&t.retrieveData()});t.$watch("requestedPage",function(){t.hasColumnsDefinitions&&t.requestCounter>0&&t.retrieveData()});t.sortColumn=function(n,i){var o=t.columns.filter(function(t){return t.Name===n}),r,u,f,e;o.length!==0&&(r=o[0],r.Sortable!==!1)&&(u=r.SortDirection,f=u==="None"?"Ascending":u==="Ascending"?"Descending":"None",f==="None"?(r.SortOrder=-1,r.SortDirection="None"):(r.SortOrder=Number.MAX_VALUE,r.SortDirection=f),i===!1&&angular.forEach(t.columns.filter(function(t){return t.Name!==n}),function(n){n.SortOrder=-1;n.SortDirection="None"}),e=t.columns.filter(function(n){return n.SortOrder>0}),e.sort(function(n,t){return n.SortOrder==t.SortOrder?0:n.SortOrder>t.SortOrder}),e.forEach(function(n,t){n.SortOrder=t+1}),t.$broadcast("tbGrid_OnColumnSorted"),t.retrieveData())};t.selectedRows=function(){var n=i.get("rows");return(n===null||n==="")&&(n=[]),n};t.clearSelection=function(){angular.forEach(t.rows,function(n){n.$selected=!1});i.set("rows",[])};t.isEmptySelection=function(){return t.selectedRows().length===0};t.selectFromSession=function(n){n.$selected=t.selectedRows().filter(function(t){return t.$key===n.$key}).length>0};t.changeSelection=function(n){if(!angular.isUndefined(n)){n.$selected=!n.$selected;var r=t.selectedRows();n.$selected?r.push({$key:n.$key}):r=r.filter(function(t){return t.$key!==n.$key});i.set("rows",r)}};t.getFullDataSource=function(n){t.gridDataService.retrieveDataAsync({serverUrl:t.serverUrl,requestMethod:t.requestMethod,timeout:t.requestTimeout,requireAuthentication:t.requireAuthentication,data:{Count:t.requestCounter,Columns:t.columns,Skip:0,Take:1e3,Search:{Argument:"",Operator:"None"}}}).promise.then(function(t){n(t.Payload)},function(n){t.$emit("tbGrid_OnConnectionError",n)}).then(function(){t.currentRequest=null})};t.$emit("tbGrid_OnGreetParentController",t)}]}}]).directive("tbGridPager",["$timeout",function(n){return{require:"^tbGrid",template:'<div class="tubular-pager"><pagination ng-disabled="$component.isEmpty" direction-links="true" boundary-links="true" total-items="$component.filteredRecordCount"items-per-page="$component.pageSize" max-size="5" ng-model="pagerPageNumber" ng-change="pagerPageChanged()"><\/pagination><div>',restrict:"E",replace:!0,transclude:!1,scope:!0,terminal:!1,controller:["$scope","$element",function(n,t){n.$component=n.$parent.$parent;n.tubularDirective="tubular-grid-pager";n.$component.$watch("currentPage",function(t){n.pagerPageNumber=t});n.pagerPageChanged=function(){n.$component.requestedPage=n.pagerPageNumber;var i=t.find("li a");$(i).blur()}}],compile:function(){return{pre:function(){},post:function(t,i,r){t.firstButtonClass=r.firstButtonClass||"fa fa-fast-backward";t.prevButtonClass=r.prevButtonClass||"fa fa-backward";t.nextButtonClass=r.nextButtonClass||"fa fa-forward";t.lastButtonClass=r.lastButtonClass||"fa fa-fast-forward";n(function(){var n=i.find("li a");$(n[0]).html('<i class="'+t.firstButtonClass+'"><\/i>');$(n[1]).html('<i class="'+t.prevButtonClass+'"><\/i>');$(n[n.length-2]).html('<i class="'+t.nextButtonClass+'"><\/i>');$(n[n.length-1]).html('<i class="'+t.lastButtonClass+'"><\/i>')},0)}}}}}]).directive("tbGridTable",[function(){return{require:"^tbGrid",template:'<table ng-transclude class="table tubular-grid-table"><\/table>',restrict:"E",replace:!0,transclude:!0,scope:!0,controller:["$scope",function(n){n.$component=n.$parent.$parent;n.tubularDirective="tubular-grid-table"}]}}]).directive("tbColumnDefinitions",[function(){return{require:"^tbGridTable",template:"<thead><tr ng-transclude><\/tr><\/thead>",restrict:"E",replace:!0,transclude:!0,scope:!0,controller:["$scope",function(n){n.$component=n.$parent.$parent.$component;n.tubularDirective="tubular-column-definitions"}],compile:function(){return{pre:function(){},post:function(n){n.$component.hasColumnsDefinitions=!0}}}}}]).directive("tbColumn",["tubulargGridColumnModel",function(n){return{require:"^tbColumnDefinitions",template:'<th ng-transclude ng-class="{sortable: column.Sortable}" ng-show="column.Visible"><\/th>',restrict:"E",replace:!0,transclude:!0,scope:!0,controller:["$scope",function(n){n.column={Label:""};n.$component=n.$parent.$parent.$component;n.tubularDirective="tubular-column";n.sortColumn=function(t){n.$component.sortColumn(n.column.Name,t)}}],compile:function(){return{pre:function(t,i,r){r.label=r.label||(r.name||"").replace(/([a-z])([A-Z])/g,"$1 $2");var u=new n(r);t.$component.addColumn(u);t.column=u;t.label=u.Label},post:function(){}}}}}]).directive("tbColumnHeader",["$timeout","tubularConst",function(n,t){return{require:"^tbColumn",template:'<a title="Click to sort. Press Ctrl to sort by multiple columns" class="column-header" ng-transclude href="javascript:void(0)" ng-click="sortColumn($event)"><\/a>',restrict:"E",replace:!0,transclude:!0,scope:!1,controller:["$scope",function(n){n.sortColumn=function(t){n.$parent.sortColumn(t.ctrlKey)}}],compile:function(){return{pre:function(i,r){var u=function(n){$(n).removeClass(t.upCssClass);$(n).removeClass(t.downCssClass);var r="";i.$parent.column.SortDirection=="Ascending"&&(r=t.upCssClass);i.$parent.column.SortDirection=="Descending"&&(r=t.downCssClass);$(n).addClass(r)};i.$on("tbGrid_OnColumnSorted",function(){u($("i.sort-icon.fa",r.parent()))});n(function(){$(r).after('&nbsp;<i class="sort-icon fa"><\/i>');var n=$("i.sort-icon.fa",r.parent());u(n)},0)},post:function(n,t){if(n.label=n.$parent.label,n.$parent.column.Sortable==!1){var i=n.label||t.text();t.replaceWith("<span>"+i+"<\/span>")}}}}}}]).directive("tbRowSet",[function(){return{require:"^tbGrid",template:"<tbody ng-transclude><\/tbody>",restrict:"E",replace:!0,transclude:!0,scope:!1,controller:["$scope",function(n){n.$component=n.$parent.$component;n.tubularDirective="tubular-row-set"}]}}]).directive("tbRowTemplate",[function(){return{require:"^tbRowSet",template:'<tr ng-transclude ng-class="{\'info\': selectableBool && rowModel.$selected}" ng-click="changeSelection(rowModel)"><\/tr>',restrict:"E",replace:!0,transclude:!0,scope:{rowModel:"=",selectable:"@"},controller:["$scope",function(n){n.selectableBool=n.selectable!="false";n.$component=n.$parent.$parent.$parent.$component;n.selectableBool&&angular.isUndefined(n.rowModel)==!1&&n.$component.selectFromSession(n.rowModel);n.changeSelection=function(t){n.selectableBool!=!1&&n.$component.changeSelection(t)}}]}}]).directive("tbCellTemplate",[function(){return{require:"^tbRowTemplate",template:'<td ng-transclude ng-show="column.Visible" data-label="{{column.Label}}"><\/td>',restrict:"E",replace:!0,transclude:!0,scope:{columnName:"@?"},controller:["$scope",function(n){if(n.column={Visible:!0},n.columnName=n.columnName||null,n.$component=n.$parent.$parent.$component,n.columnName!=null){var t=n.$component.columns.filter(function(t){return t.Name==n.columnName});t.length>0&&(n.column=t[0])}}]}}]).directive("tbGridPagerInfo",[function(){return{require:"^tbGrid",template:'<div class="pager-info small">Showing {{currentInitial}} to {{currentTop}} of {{$component.filteredRecordCount}} records <span ng-show="filtered">(Filtered from {{$component.totalRecordCount}} total records)<\/span><\/div>',restrict:"E",replace:!0,transclude:!0,scope:!0,controller:["$scope",function(n){n.$component=n.$parent.$parent;n.fixCurrentTop=function(){n.currentTop=n.$component.pageSize*n.$component.currentPage;n.currentInitial=(n.$component.currentPage-1)*n.$component.pageSize+1;n.currentTop>n.$component.filteredRecordCount&&(n.currentTop=n.$component.filteredRecordCount);n.currentTop<0&&(n.currentTop=0);n.currentInitial<0&&(n.currentInitial=0)};n.$component.$watch("filteredRecordCount",function(){n.filtered=n.$component.totalRecordCount!=n.$component.filteredRecordCount;n.fixCurrentTop()});n.$component.$watch("currentPage",function(){n.fixCurrentTop()});n.$component.$watch("pageSize",function(){n.fixCurrentTop()});n.fixCurrentTop()}]}}]).directive("tbEmptyGrid",[function(){return{require:"^tbGrid",template:'<tr ngTransclude ng-show="$parent.$component.isEmpty"><td class="bg-warning" colspan="{{$parent.$component.columns.length + 1}}"><b>No records found<\/b><\/td><\/tr>',restrict:"E",replace:!0,transclude:!0,scope:!1}}])})();
//# sourceMappingURL=tubular-directives.min.js.map
