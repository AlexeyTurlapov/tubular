(function(){"use strict";angular.module("tubular.services").service("tubularHttp",["$http","$timeout","$q","$cacheFactory","$cookieStore",function(n,t,i,r,u){function e(n){var t=new Date;return n=new Date(n),n-t<=0}function h(){o();u.put("auth_data",f.userData)}function o(){u.remove("auth_data")}function c(){var n=u.get("auth_data");if(typeof n=="undefined")throw new Exception("No authentication data exists");else if(e(n.expirationDate))throw new Exception("Authentication token has already expired");else f.userData=n,s()}function l(){f.userData.isAuthenticated=!1;f.userData.username="";f.userData.bearerToken="";f.userData.expirationDate=null}function s(){n.defaults.headers.common.Authorization="Bearer "+f.userData.bearerToken}var f=this;f.userData={isAuthenticated:!1,username:"",bearerToken:"",expirationDate:null};f.cache=r("tubularHttpCache");f.useCache=!0;f.requireAuthentication=!0;f.isAuthenticated=function(){if(!f.userData.isAuthenticated||e(f.userData.expirationDate))try{c()}catch(n){return!1}return!0};f.setRequireAuthentication=function(n){f.requireAuthentication=n};f.removeAuthentication=function(){o();l();n.defaults.headers.common.Authorization=null};f.authenticate=function(t,i,r,u,e){this.removeAuthentication();var o={method:"POST",url:"/api/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:"grant_type=password&username="+t+"&password="+i};n(o).success(function(n){f.userData.isAuthenticated=!0;f.userData.username=n.userName;f.userData.bearerToken=n.access_token;f.userData.expirationDate=new Date(n[".expires"]);s();e===!0&&h();typeof r=="function"&&r()}).error(function(n){typeof u=="function"&&(n.error_description?u(n.error_description):u("Unable to contact server; please, try again later."))})};f.saveDataAsync=function(n,t){var i=angular.copy(n),u=angular.copy(n.$original),r;return delete i.$isEditing,delete i.$hasChanges,delete i.$selected,delete i.$original,delete i.$state,delete i.$valid,t.data={Old:u,New:i},r=f.retrieveDataAsync(t),r.promise.then(function(t){return n.$hasChanges=!1,n.resetOriginal(),t}),r};f.getExpirationDate=function(){var n=new Date;return new Date(n.getTime()+3e5)};f.checksum=function(n){for(var u=Object.keys(n).sort(),t=[],i,r=0;r<u.length;r++)i=u[r],t.push(i),t.push(n[i]);return JSON.stringify(t)};f.retrieveDataAsync=function(r){var s=i.defer(),u=function(n){console.error(n);s.resolve(n)},o,e,h,c;return(r.requireAuthentication=angular.isString(r.requireAuthentication)?r.requireAuthentication=="true":r.requireAuthentication||f.requireAuthentication,r.requireAuthentication&&f.isAuthenticated()==!1)?{promise:i(function(n){n(null)}),cancel:u}:(o=f.checksum(r),(r.requestMethod=="GET"||r.requestMethod=="POST")&&f.useCache&&(e=f.cache.get(o),angular.isDefined(e)&&e.Expiration.getTime()>(new Date).getTime()))?{promise:i(function(n){n(e.Set)}),cancel:u}:(h=n({url:r.serverUrl,method:r.requestMethod,data:r.data,timeout:s.promise}).then(function(n){return t.cancel(c),f.useCache&&f.cache.put(o,{Expiration:f.getExpirationDate(),Set:n.data}),n.data},function(n){angular.isDefined(n)&&angular.isDefined(n.status)&&n.status==401&&f.isAuthenticated()&&(f.removeAuthentication(),document.location=document.location)}),r.timeout=r.timeout||15e3,c=t(function(){u("Timed out")},r.timeout),{promise:h,cancel:u})};f.get=function(n){return f.retrieveDataAsync({serverUrl:n,requestMethod:"GET"})};f.delete=function(n){return f.retrieveDataAsync({serverUrl:n,requestMethod:"DELETE"})};f.post=function(n,t){return f.retrieveDataAsync({serverUrl:n,requestMethod:"POST",data:t})};f.put=function(n,t){return f.retrieveDataAsync({serverUrl:n,requestMethod:"PUT",data:t})}}])})();
//# sourceMappingURL=tubular-services-http.min.js.map
