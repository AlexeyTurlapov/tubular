(function(){"use strict";angular.module("tubular.services",["ui.bootstrap"]).service("tubularHttp",["$http","$timeout","$q","$cacheFactory","$cookieStore",function(n,t,i,r,u){function e(n){var t=new Date;return n=new Date(n),n-t<=0}function h(){o();u.put("auth_data",f.userData)}function o(){u.remove("auth_data")}function c(){var n=u.get("auth_data");if(typeof n=="undefined")throw new Exception("No authentication data exists");else if(e(n.expirationDate))throw new Exception("Authentication token has already expired");else f.userData=n,s()}function l(){f.userData.isAuthenticated=!1;f.userData.username="";f.userData.bearerToken="";f.userData.expirationDate=null}function s(){n.defaults.headers.common.Authorization="Bearer "+f.userData.bearerToken}var f=this;f.userData={isAuthenticated:!1,username:"",bearerToken:"",expirationDate:null};f.cache=r("tubularHttpCache");f.useCache=!0;f.isAuthenticated=function(){if(!f.userData.isAuthenticated||e(f.userData.expirationDate))try{c()}catch(n){return!1}return!0};f.removeAuthentication=function(){o();l();n.defaults.headers.common.Authorization=null};f.authenticate=function(t,i,r,u,e){this.removeAuthentication();var o={method:"POST",url:"/api/token",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:"grant_type=password&username="+t+"&password="+i};n(o).success(function(n){f.userData.isAuthenticated=!0;f.userData.username=n.userName;f.userData.bearerToken=n.access_token;f.userData.expirationDate=new Date(n[".expires"]);s();e===!0&&h();typeof r=="function"&&r()}).error(function(n){typeof u=="function"&&(n.error_description?u(n.error_description):u("Unable to contact server; please, try again later."))})};f.saveDataAsync=function(n,t){var i=angular.copy(n),u=angular.copy(n.$original),r;return delete i.$isEditing,delete i.$hasChanges,delete i.$selected,delete i.$original,delete i.$state,delete i.$valid,t.data={Old:u,New:i},r=f.retrieveDataAsync(t),r.promise.then(function(t){return n.$hasChanges=!1,n.resetOriginal(),t}),r};f.getExpirationDate=function(){var n=new Date;return new Date(n.getTime()+3e5)};f.checksum=function(n){for(var u=Object.keys(n).sort(),t=[],i,r=0;r<u.length;r++)i=u[r],t.push(i),t.push(n[i]);return JSON.stringify(t)};f.retrieveDataAsync=function(r){var o=f.checksum(r),s=i.defer(),e=function(n){console.error(n);s.resolve(n)},u,h,c;return(r.requestMethod=="GET"||r.requestMethod=="POST")&&f.useCache&&(u=f.cache.get(o),angular.isDefined(u)&&u.Expiration.getTime()>(new Date).getTime())?{promise:i(function(n){n(u.Set)}),cancel:e}:(h=n({url:r.serverUrl,method:r.requestMethod,data:r.data,timeout:s.promise}).then(function(n){return t.cancel(c),f.useCache&&f.cache.put(o,{Expiration:f.getExpirationDate(),Set:n.data}),n.data}),r.timeout=r.timeout||15e3,c=t(function(){e("Timed out")},r.timeout),{promise:h,cancel:e})};f.get=function(n){return f.retrieveDataAsync({serverUrl:n,requestMethod:"GET"})};f.delete=function(n){return f.retrieveDataAsync({serverUrl:n,requestMethod:"DELETE"})};f.post=function(n,t){return f.retrieveDataAsync({serverUrl:n,requestMethod:"POST",data:t})};f.put=function(n,t){return f.retrieveDataAsync({serverUrl:n,requestMethod:"PUT",data:t})}}]).service("tubularGridPopupService",["$modal",function(n){var t=this;t.openDialog=function(t,i){var r=n.open({templateUrl:t,backdropClass:"fullHeight",controller:["$scope",function(n){n.Model=i;n.savePopup=function(){n.Model.save(!0);n.$on("tbGrid_OnSuccessfulUpdate",function(){r.close()})};n.closePopup=function(){angular.isDefined(n.Model.revertChanges)&&n.Model.revertChanges();r.close()}}]});return r}}]).service("tubularGridExportService",function(){var n=this;n.getColumns=function(n){return n.columns.map(function(n){return n.Name.replace(/([a-z])([A-Z])/g,"$1 $2")})};n.exportAllGridToCsv=function(t,i){var r=n.getColumns(i);i.getFullDataSource(function(i){n.exportToCsv(t,r,i)})};n.exportGridToCsv=function(t,i){var r=n.getColumns(i);i.currentRequest={};n.exportToCsv(t,r,i.dataSource.Payload);i.currentRequest=null};n.exportToCsv=function(n,t,i){var f=function(n){for(var u,i,r="",t=0;t<n.length;t++)u=n[t]===null?"":n[t].toString(),n[t]instanceof Date&&(u=n[t].toLocaleString()),i=u.replace(/"/g,'""'),i.search(/("|,|\n)/g)>=0&&(i='"'+i+'"'),t>0&&(r+=","),r+=i;return r+"\n"},u="",r,e;for(t.length>0&&(u+=f(t)),r=0;r<i.length;r++)u+=f(i[r]);e=new Blob([u],{type:"text/csv;charset=utf-8;"});$script("//cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2014-11-29/FileSaver.min.js",function(){saveAs(e,n)})}}).service("tubularGridFilterService",["tubulargGridFilterModel","$compile",function(n,t){var i=this;i.applyFilterFuncs=function(n,i,r){n.$component=n.$parent.$component;n.filterTitle="Filter";n.clearFilter=function(){n.filter.Operator="None";n.filter.Text="";n.filter.Argument=[];n.$component.retrieveData();n.close()};n.applyFilter=function(){n.$component.retrieveData();n.close()};n.close=function(){$(i).find('[data-toggle="popover"]').popover("hide")};$(i).find('[data-toggle="popover"]').popover({html:!0,title:n.filterTitle,content:function(){var i=$(this).next().find("select").find("option").remove().end();return angular.forEach(n.filterOperators,function(n,t){$(i).append('<option value="'+t+'">'+n+"<\/option>")}),t($(this).next().html())(n)}});$(i).find('[data-toggle="popover"]').on("shown.bs.popover",r)};i.createFilterModel=function(t,i){t.filter=new n(i);t.filter.Name=t.$parent.column.Name;var r=t.$component.columns.filter(function(n){return n.Name===t.filter.Name});r.length!==0&&(r[0].Filter=t.filter,t.dataType=r[0].DataType,t.filterOperators=r[0].FilterOperators[t.dataType],(t.dataType=="datetime"||t.dataType=="date")&&(t.filter.Argument=[new Date]),t.dataType=="numeric"&&(t.filter.Argument=[1]),t.filterTitle=i.title||"Filter")}}]).service("tubularEditorService",[function(){var n=this;n.defaultScope={value:"=?",state:"=?",isEditing:"=?",editorType:"@",showLabel:"=?",label:"@?",required:"=?",format:"=?",min:"=?",max:"=?",name:"@",defaultValue:"=?",IsKey:"@",placeholder:"@?",readOnly:"=?",help:"@?"};n.setupScope=function(n,t){n.isEditing=angular.isUndefined(n.isEditing)?!0:n.isEditing;n.showLabel=n.showLabel||!1;n.label=n.label||(n.name||"").replace(/([a-z])([A-Z])/g,"$1 $2");n.required=n.required||!1;n.readOnly=n.readOnly||!1;n.format=n.format||t;n.$valid=!0;n.$editorType="input";angular.isUndefined(n.defaultValue)==!1&&angular.isUndefined(n.value)&&(n.value=n.defaultValue);n.$watch("value",function(t,i){if(!angular.isUndefined(i)||!angular.isUndefined(t)){if(angular.isUndefined(n.state)&&(n.state={$valid:function(){return this.$errors==0},$errors:[]}),n.$valid=!0,n.state.$errors=[],angular.isDefined(n.$parent.Model)&&(angular.isDefined(n.$parent.Model[n.name])?n.$parent.Model[n.name]=t:angular.isDefined(n.$parent.Model.$addField)&&n.$parent.Model.$addField(n.name,t)),angular.isUndefined(n.value)&&n.required){n.$valid=!1;n.state.$errors=["Field is required"];return}angular.isUndefined(n.validate)||n.validate()}});for(var i=n.$parent;;){if(i==null)break;if(angular.isUndefined(i.tubularDirective)==!1&&i.tubularDirective=="tubular-form"){i.addField(n);break}i=i.$parent}}}])})();
//# sourceMappingURL=tubular-services.min.js.map
